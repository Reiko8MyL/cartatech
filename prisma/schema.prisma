// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String // Hasheada con bcrypt
  role      String   @default("USER") // "USER", "MODERATOR", "ADMIN"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  decks       Deck[]
  favorites   FavoriteDeck[]
  deckVersions DeckVersion[]
  deckLikes   DeckLike[]
  votes       Vote[]
  collection  UserCollection?
  comments    Comment[]
  notifications Notification[]

  @@map("users")
}

model Deck {
  id          String   @id @default(cuid())
  name        String
  description String?
  cards       Json     // Array de DeckCard[]
  format      String   @default("RE") // RE, RL, LI
  isPublic    Boolean  @default(false)
  publishedAt DateTime?
  techCardId  String?
  backgroundImage String? // URL de la imagen de fondo personalizada del banner
  viewCount   Int      @default(0)
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  favorites   FavoriteDeck[]
  versions    DeckVersion[]
  likes       DeckLike[]
  comments    Comment[]
  shareCodes  ShareCode[]

  @@index([userId])
  @@index([isPublic])
  @@index([publishedAt])
  @@map("decks")
}

model DeckVersion {
  id          String   @id @default(cuid())
  deckId      String
  name        String
  description String?
  cards       Json     // Array de DeckCard[]
  format      String
  tags        String[] @default([])
  createdAt   DateTime @default(now())

  // Relaciones
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck        Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@index([deckId])
  @@index([userId])
  @@map("deck_versions")
}

model FavoriteDeck {
  id        String   @id @default(cuid())
  userId    String
  deckId    String
  createdAt DateTime @default(now())

  // Relaciones
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck      Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([userId, deckId])
  @@index([userId])
  @@index([deckId])
  @@map("favorite_decks")
}

model DeckLike {
  id        String   @id @default(cuid())
  userId    String
  deckId    String
  createdAt DateTime @default(now())

  // Relaciones
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck      Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([userId, deckId])
  @@index([userId])
  @@index([deckId])
  @@map("deck_likes")
}

model Vote {
  id        String   @id @default(cuid())
  userId    String
  race      String
  cardId    String
  createdAt DateTime @default(now())

  // Relaciones
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, race])
  @@index([userId])
  @@index([race])
  @@index([cardId])
  @@map("votes")
}

model UserCollection {
  id        String   @id @default(cuid())
  userId    String   @unique
  cardIds   String[] @default([]) // Array de IDs de cartas
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_collections")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  deckId    String
  userId    String
  parentId  String?  // Para respuestas anidadas
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck      Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([deckId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "like", "comment", "follow", "featured"
  title     String
  message   String
  link      String?  // URL relacionada
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relaciones
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model CardMetadata {
  id              String   @id @default(cuid())
  cardId          String   @unique // ID de la carta (ej: "MYL-0001")
  backgroundPositionY Int?  // Posición Y personalizada (porcentaje, ej: 20, 25, 30)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([cardId])
  @@map("card_metadata")
}

model Card {
  id                String   @id // ID de la carta (ej: "MYL-0001" o "MYL-0001-01")
  name              String
  type              String   // "Aliado", "Arma", "Talismán", "Tótem", "Oro"
  cost              Int?     // Coste de la carta (null para Oro y Tótem)
  power             Int?     // Fuerza de la carta (null para Talismán, Tótem, Oro)
  race              String?  // Raza (null para Talismán, Tótem, Oro)
  isCosmetic        Boolean  @default(false) // true para cartas con arte alternativo
  isRework          Boolean  @default(false)
  isUnique          Boolean  @default(false)
  edition           String
  banListRE         Int      @default(3) // 0=BAN, 1=Max 1, 2=Max 2, 3=Libre
  banListRL         Int      @default(3)
  banListLI         Int      @default(3)
  isOroIni          Boolean  @default(false)
  image             String
  description       String   @default("")
  baseCardId        String?  // ID base para cartas alternativas (ej: "MYL-0001" para "MYL-0001-01")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relación con carta base (para cartas alternativas)
  baseCard          Card?    @relation("CardAlternatives", fields: [baseCardId], references: [id], onDelete: Cascade)
  alternativeCards  Card[]   @relation("CardAlternatives")

  @@index([id])
  @@index([baseCardId])
  @@index([name])
  @@index([type])
  @@index([edition])
  @@index([isCosmetic])
  @@map("cards")
}

model ShareCode {
  id          String   @id @default(cuid())
  code        String   @unique // Código corto único (ej: "abc123")
  deckId      String
  clickCount  Int      @default(0) // Contador de clics para analytics
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // Fecha de expiración opcional

  // Relaciones
  deck        Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([deckId])
  @@index([createdAt])
  @@map("share_codes")
}

model DeckPanelBannerSettings {
  id                String   @id @default(cuid())
  context           String   // "mis-mazos", "mazos-comunidad", "favoritos", "deck-builder"
  viewMode          String   @default("grid") // "grid", "list"
  device            String   @default("desktop") // "desktop", "tablet", "mobile"
  backgroundImageId String?  // ID de la imagen específica (null = ajustes por defecto para todas)
  backgroundPositionX Float  @default(50.0) // Posición X en porcentaje (0-100)
  backgroundPositionY Float  @default(50.0) // Posición Y en porcentaje (0-100)
  backgroundSize     String   @default("cover") // "cover", "contain", o porcentaje como "135%"
  height             Int      @default(128) // Altura en píxeles
  overlayOpacity     Float    @default(0.6) // Opacidad del overlay (0.0 a 1.0)
  overlayGradient    String   @default("to-t") // Dirección del gradiente: "to-t", "to-b", "to-l", "to-r"
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([context, viewMode, device, backgroundImageId])
  @@index([context])
  @@index([backgroundImageId])
  @@map("deck_panel_banner_settings")
}

